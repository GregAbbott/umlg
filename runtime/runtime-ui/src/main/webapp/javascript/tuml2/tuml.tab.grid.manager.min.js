!function(e){function t(t){this.TumlQueryGridManager="1.0.0";var i=this;this.tumlTabViewManager=t,this.setupColumns=function(){r.prototype.setupColumns.call(this,this.localMetaForData),this.columns.push({id:"uri",name:"uri",field:"uri",sortable:!1,formatter:TumlSlick.Formatters.Link}),i.columns.splice(0,0,{id:"row",name:"row",field:"row",sortable:!0})},this.refresh=function(t,i){this.result=t,this.metaForDataTo=t.meta.to,this.gridDivName=i;var a=e("#"+this.gridDivName);a.children().remove(),e("<div />",{id:"queryResultsDiv"}),e('<div id="serverErrorMsg'+this.gridDivName+'" />').appendTo(a);var o=e(".query-center").height()-40;e("<div />",{id:"queryResultsDiv"+this.gridDivName,style:"width:auto;height:"+o+"px;"}).appendTo(a),e("<div />",{id:"pagerQueryResultsDiv"+this.gridDivName,style:"width:auto;height:20px;"}).appendTo(a),e("#contextMenu"+this.gridDivName).remove(),this.createGrid(t.data,-1)},this.instantiateGrid=function(){this.grid=new Slick.Grid("#queryResultsDiv"+this.gridDivName,this.dataView,this.columns,this.options),this.pager=new Slick.Controls.Pager(this.dataView,this.grid,e("#pagerQueryResultsDiv"+this.gridDivName)),e("<div id='grid-buttonQueryComponent"+this.localMetaForData.name+"' class='grid-button'/>").appendTo("#pagerQueryResultsDiv"+this.gridDivName+" .slick-pager-settings"),this.grid.manyEditorOpen=!1,this.grid.setSelectionModel(new Slick.RowSelectionModel),new Slick.Controls.ColumnPicker(this.columns,this.grid,this.options)}}function i(e,t,i){this.TumlManyComponentGridManager="1.0.0",r.call(this,e,t,i),this.setupColumns=function(){r.prototype.setupColumns.call(this,this.localMetaForData),this.columns.push({id:"uri",name:"uri",field:"uri",sortable:!1,formatter:TumlSlick.Formatters.Link}),this.columns.push({id:"delete",name:"delete",field:"delete",sortable:!1,formatter:TumlSlick.Formatters.TumlDelete})}}function a(t,i,o){this.TumlForManyLookupGridManager="1.0.0",r.call(this,t,i,o),this.setupOptions=function(){r.prototype.setupOptions.call(this),this.options.editable=!1},this.refresh=function(t,o){this.metaForDataTo=t.meta.to;var r,n=o;r=this instanceof Tuml.TumlManyComponentGridManager?600:e(".ui-layout-center").height()-188,e('<div id="serverErrorMsg" />').appendTo(n),e("<div />",{id:"myGridLookup"+this.metaForDataTo.name,style:"width:auto;height:"+r+"px;"}).appendTo(n),e("<div />",{id:"pagerLookup"+this.metaForDataTo.name,style:"width:auto;height:20px;"}).appendTo(n),this instanceof a||e("#contextMenu"+this.metaForDataTo.name).remove(),this.createGrid(t.data,i)},this.instantiateGrid=function(){this.grid=new Slick.Grid("#myGridLookup"+this.localMetaForData.name,this.dataView,this.columns,this.options),this.pager=new Slick.Controls.Pager(this.dataView,this.grid,e("#pagerLookup"+this.localMetaForData.name)),e("<div id='grid-buttonLookup"+this.localMetaForData.name+"' class='grid-button'/>").appendTo("#pagerLookup"+this.localMetaForData.name+" .slick-pager-settings"),this.grid.manyEditorOpen=!1,this.grid.setSelectionModel(new Slick.RowSelectionModel),new Slick.Controls.ColumnPicker(this.columns,this.grid,this.options)}}function o(e,t,i){this.TumlTabGridManager="1.0.0",r.call(this,e,t,i),this.setFocus=function(){this.grid.focus();var e=this.grid.getActiveCell();null===e&&this.grid.setActiveCell(0,0)},this.setupColumns=function(){r.prototype.setupColumns.call(this,this.localMetaForData),this.columns.push({id:"uri",name:"uri",field:"uri",sortable:!1,formatter:TumlSlick.Formatters.Link}),(!this.propertyNavigatingTo.associationClassOne||this.propertyNavigatingTo.memberEndOfAssociationClass)&&this.columns.push({id:"delete",name:"delete",field:"delete",sortable:!1,formatter:TumlSlick.Formatters.TumlDelete})}}function r(t,i,a){this.TumlBaseGridManager="1.0.0",this.tumlTabViewManager=t,this.tumlUri=i,this.propertyNavigatingTo=a,this.active=!1;var o=this;this.columns=[],this.containsOneToOne=!1,this.calculateContainsOne=function(){for(var e=0;e<this.metaForDataTo.properties.length;e++){var t=this.metaForDataTo.properties[e];if(t.oneToOne&&!t.composite&&!t.inverseComposite&&!t.onePrimitive){this.containsOneToOne=!0;break}}},this.cancel=function(e){Slick.GlobalEditorLock.commitCurrentEdit()&&(this.grid.resetActiveCell(),this.setData(e),this.grid.invalidateAllRows(),this.grid.updateRowCount(),this.grid.render())},this.clearArraysAfterCommit=function(){this.dataView.clearArraysAfterCommit()},this.beginUpdate=function(){this.dataView.beginUpdate()},this.endUpdate=function(e){this.dataView.endUpdate(),this.grid.invalidateAllRows(),this.grid.render(),e&&this.active&&this.grid.editActiveCell()},this.updateGridAfterRollback=function(e){this.dataView.refreshItemAfterRollback(e,this.propertyNavigatingTo.composite)},this.updateGridAfterCommit=function(e){this.dataView.refreshItemAfterCommit(e,this.propertyNavigatingTo.composite)},this.handleContextMenuClickLink=function(e){this.tumlTabViewManager.refreshContext(e)},this.handleLookup=function(e,t,i){this.tumlTabViewManager.handleLookup(e,t,i)},this.handleAddNewRow=function(){if(Slick.GlobalEditorLock.cancelCurrentEdit()){var e,t=Tuml.TumlFakeIndex++;if(this.propertyNavigatingTo.memberEndOfAssociationClass){e={id:"fake::"+t,tmpId:"fake::"+t};var i="fake::"+Tuml.TumlFakeIndex++;e[this.propertyNavigatingTo.inverseAssociationClassPropertyName]={id:i,tmpId:i,displayName:null,refreshFromDb:!0}}else e={id:"fake::"+t,tmpId:"fake::"+t};e.qualifiedName=this.localMetaForData.qualifiedName,this.dataView.addItem(e),this.tumlTabViewManager.saveNewRow(),this.containsOneToOne&&this.tumlTabViewManager.parentTabContainerManager.addToOneToOneIndex(e.id,{id:e.id,qualifiedName:e.qualifiedName})}},this.updateDataModelForOneToOne=function(){if(this.containsOneToOne)for(var e=this.dataView.getNewItems(),t=0;t<e.length;t++)for(var i=e[t],a=0;a<this.metaForDataTo.properties.length;a++){var o=this.metaForDataTo.properties[a];!o.oneToOne||o.composite||o.inverseComposite||o.onePrimitive||void 0===i[o.name]||null===i[o.name]||void 0===i[o.name].id||(this.tumlTabViewManager.updateDataModelForOneToOne(i[o.name].previousId,o.inverseName,{}),this.tumlTabViewManager.updateDataModelForOneToOne(i[o.name].id,o.inverseName,i))}},this.updateDataModelForOneToOneForUpdate=function(){for(var e=this.dataView.getUpdatedItems(),t=0;t<e.length;t++)for(var i=e[t],a=0;a<this.metaForDataTo.properties.length;a++){var o=this.metaForDataTo.properties[a];!o.oneToOne||o.composite||o.inverseComposite||o.onePrimitive||void 0===i[o.name]||null===i[o.name]||void 0===i[o.name].id||isNaN(i[o.name].id)||this.tumlTabViewManager.updateDataModelForOneToOneForUpdatedItem(this.metaForDataTo.qualifiedName,i[o.name].id,i[o.name].displayName,o.inverseName,i)}},this.handleDeleteRow=function(e){if(Slick.GlobalEditorLock.commitCurrentEdit()){var t=null!=this.grid.getActiveCell()&&this.grid.getActiveCell().row>=e,i=this.dataView.getItem(e);this.dataView.deleteItem(i.id),this.tumlTabViewManager.handleDeleteRow(),t&&(this.dataView.getItems().length>0?this.grid.setActiveCell(this.grid.getActiveCell().row-1,this.grid.getActiveCell().cell):this.grid.resetActiveCell())}},this.removeGrid=function(){for(var t=0;t<this.columns.length;t++)if("selector"!==this.columns[t].id&&"uri"!==this.columns[t].id&&"delete"!==this.columns[t].id){var i=this.grid.getHeaderRowColumn(this.columns[t].id);e(i).empty()}this.grid.destroy()},this.createGrid=function(t,i){function a(e){return!e.options.property.manyPrimitive&&!e.options.property.manyEnumeration&&e.options.property.composite&&e.options.property.lower>0&&(e.options.property.upper>1||-1===e.options.property.upper)}function o(e,t){var i=[];if(s(e,t.row,c.dataView.getItem(t.row))){void 0!==c.dataView.getItem(t.row)&&null!==c.dataView.getItem(t.row)&&void 0!==c.dataView.getItem(t.row)[e.name]&&null!==c.dataView.getItem(t.row)[e.name]&&(i=c.dataView.getItem(t.row)[e.name]);{c.dataView.getItem(t.row).id}c.tumlTabViewManager.openManyComponent(i,t,e.options.property.tumlUri,e.options.property)}}function r(e){return!e.options.property.manyPrimitive&&!e.options.property.manyEnumeration&&e.options.property.composite&&1===e.options.property.lower&&1===e.options.property.upper}function n(e,t){var i=null;s(e,t.row,c.dataView.getItem(t.row))&&(i=void 0!==c.dataView.getItem(t.row)&&null!==c.dataView.getItem(t.row)&&void 0!==c.dataView.getItem(t.row)[e.name]&&null!==c.dataView.getItem(t.row)[e.name]?c.dataView.getItem(t.row)[e.name]:{},c.tumlTabViewManager.openOneComponent(i,t,e.options.property.tumlUri,e.options.property))}function s(e,t,i){if("id"!==e.name&&"uri"!==e.name&&"delete"!==e.name&&!e.options.property.readOnly){var a=e.options.property;if(a.composite&&a.lower>=1||a.associationClassOne)return t>=c.dataView.getItems().length||-1!==c.dataView.getNewItems().indexOf(i)?!a.associationClassOne||a.memberEndOfAssociationClass||a.composite||!a.oneToOne&&!a.manyToOne?!0:void 0!==c.dataView.getItem(t)[e.name]&&null!==c.dataView.getItem(t)[e.name]&&void 0!==c.dataView.getItem(t)[e.name].tmpId?!0:(c instanceof Tuml.TumlForManyLookupGridManager||alert("Select an association before setting the association class!"),!1):!a.associationClassOne||a.memberEndOfAssociationClass||a.composite||!a.oneToOne&&!a.manyToOne?!1:void 0!==c.dataView.getItem(t)[e.name]&&null!==c.dataView.getItem(t)[e.name]&&void 0!==c.dataView.getItem(t)[e.name].tmpId?!0:(c instanceof Tuml.TumlForManyLookupGridManager||a.inverseQualifiedName===this.propertyNavigatingTo.qualifiedName||alert("Select an association before setting the association class!"),!1)}return!0}function l(e,t,i){for(var a=0;a<c.grid.getColumns().length;a++){var o=c.grid.getColumns()[a];if(t===a)return s(o,e,i);if(a>t)break}return!0}function d(e){return e>=c.dataView.getItems().length?!0:!1}function m(e,t){for(var i=0;i<t.properties.length;i++){var a=t.properties[i];if(a.name==e&&"String"==a.fieldType)return"<input type='text'>";if(a.name==e&&("Integer"==a.fieldType||"Long"==a.fieldType||"Real"==a.fieldType))return"<input type='text'>";if(a.name==e&&"Boolean"==a.fieldType)return"<select><option value='None'>None</option><option value='true'>True</option><option value='false'>False</option></select>"}return"<input type='text'>"}function p(e,t){for(var i in u)if(void 0!==i&&""!==u[i])for(var a=c.grid.getColumns()[c.grid.getColumnIndex(i)],o=0;o<t.metaForData.properties.length;o++){var r=t.metaForData.properties[o];if(r.name==i)if(null!=r.dataTypeEnum&&void 0!==r.dataTypeEnum)if("Date"==r.dataTypeEnum){if(null==e[a.field]||-1==e[a.field].indexOf(u[i]))return!1}else if("Time"==r.dataTypeEnum){if(void 0==e[a.field]||-1==e[a.field].indexOf(u[i]))return!1}else if("DateTime"==r.dataTypeEnum){if(void 0==e[a.field]||-1==e[a.field].indexOf(u[i]))return!1}else if("InternationalPhoneNumber"==r.dataTypeEnum){if(void 0==e[a.field]||-1==e[a.field].indexOf(u[i]))return!1}else if("LocalPhoneNumber"==r.dataTypeEnum){if(void 0==e[a.field]||-1==e[a.field].indexOf(u[i]))return!1}else if("Email"==r.dataTypeEnum){if(void 0==e[a.field]||-1==e[a.field].indexOf(u[i]))return!1}else alert("Unsupported dataType "+r.dataTypeEnum);else if(r.onePrimitive||r.manyPrimitive||r.composite){if("String"==r.fieldType){if(void 0!==e[a.field]&&-1==e[a.field].indexOf(u[i]))return!1}else if("Integer"==r.fieldType||"Long"==r.fieldType||"Real"==r.fieldType){if(e[a.field]!=u[i])return!1}else if("Boolean"==r.fieldType){var n="None"===u[i];if(!n){var s="true"===u[i];if(e[a.field]!=s)return!1}}}else{if(void 0==e[a.field].displayName&&e[a.field]!=u[i])return!1;if(void 0!==e[a.field].displayName&&-1==e[a.field].displayName.indexOf(u[i]))return!1}}return!0}var u={},c=this;this.data=t,this.contextVertexId=-1!==i?retrieveVertexId(i):-1,this.localMetaForData=this.metaForDataTo,this.setupColumns(),this.setupOptions();var h="name",g=1;this.dataView=new Tuml.Slick.Data.DataView,this.instantiateGrid(),void 0!==this.propertyNavigatingTo&&!this.propertyNavigatingTo.associationClassOne&&this.propertyNavigatingTo.ordered&&this.setupRowDrag(),this.createContextMenu(),this.grid.onContextMenu.subscribe(function(e,t){e.preventDefault();var i=t.grid.getCellFromEvent(e);c.dataView.isNewRow(c.dataView.getItemByIdx(i.row).id)||c.showContextMenu(i,e.pageX,e.pageY)}),this.grid.onClick.subscribe(function(e,t){if(Slick.GlobalEditorLock.commitCurrentEdit()){var i=c.grid.getColumns()[t.cell];if(d(t.row));else if("id"==i.name)e.stopImmediatePropagation();else if("delete"==i.name)c.handleDeleteRow(t.row,c.data),e.stopImmediatePropagation();else if("uri"==i.name){var l=c.dataView.getItem(t.row),m=l.uri.replace(new RegExp("{(s*?.*?)*?}","gi"),encodeURIComponent(l.id));c.tumlTabViewManager.refreshContext(m)}else if(a(i))o(i,t),e.stopImmediatePropagation();else if(r(i))n(i,t),e.stopImmediatePropagation();else if(i.options.property.associationClassOne){var p=null;s(i,t.row,c.dataView.getItem(t.row))&&(p=void 0!==c.dataView.getItem(t.row)&&null!==c.dataView.getItem(t.row)&&void 0!==c.dataView.getItem(t.row)[i.name]&&null!==c.dataView.getItem(t.row)[i.name]?c.dataView.getItem(t.row)[i.name]:null!==c.dataView.getItem(t.row)[i.name]&&void 0!==c.dataView.getItem(t.row)[i.name].tmpId?c.dataView.getItem(t.row)[i.name]:{},c.tumlTabViewManager.openAssociationClass(p,t,i.options.property.tumlUri,i.options.property)),e.stopImmediatePropagation()}c.grid.clicked=!0}else e.stopImmediatePropagation()}),this.grid.onCellChange.subscribe(function(e,t){var i=c.grid.getColumns()[t.cell];c.dataView.updateItem(t.item.id,t.item,i.name);var a=i.options.property;!a.associationClassOne&&a.memberEndOfAssociationClass&&c.dataView.updateItem(t.item.id,t.item,a.associationClassPropertyName),a.composite||a.inverseComposite||a.onePrimitive||a.oneEnumeration||1!==a.upper||(c.tumlTabViewManager instanceof Tuml.TumlTabManyComponentViewManager?c.updateDataModelForOneToOne():c.updateDataModelForOneToOneForUpdate())}),this.grid.onKeyDown.subscribe(function(e){if(c.grid.manyPrimitiveEditorOpen&&c.grid.manyPrimitiveEditor.handleKeyPress(e),39==e.which&&e.ctrlKey){e.preventDefault();var t=c.grid.getActiveCell(),i=c.grid.getActiveCellPosition();c.showContextMenu(t,i.left+i.width,i.top),e.stopImmediatePropagation()}else if(13===e.which){var t=c.grid.getActiveCell(),s=c.grid.getColumns()[t.cell];a(s)?o(s,{row:t.row,cell:t.cell,grid:c.grid}):r(s)&&n(s,{row:t.row,cell:t.cell,grid:c.grid})}else{if(65!=e.which||!e.ctrlKey)return!1;for(var l=[],d=0;d<c.dataView.getLength();d++)l.push(d);c.grid.setSelectedRows(l),e.preventDefault(),e.stopImmediatePropagation()}}),this.grid.onSort.subscribe(function(t,i){if(g=i.sortAsc?1:-1,h=i.sortCol.field,void 0!==e.browser&&e.browser.msie&&e.browser.version<=8){var a=function(){var e=this.percentComplete;return 10>e?"00"+e:100>e?"0"+e:e};c.dataView.fastSort("percentComplete"==h?a:h,i.sortAsc)}else c.dataView.sort(function(e,t){var i=e[h],a=t[h];return i==a?0:i>a?1:-1},i.sortAsc)}),this.dataView.onRowCountChanged.subscribe(function(){c.grid.updateRowCount(),c.grid.render()}),this.dataView.onRowsChanged.subscribe(function(e,t){c.grid.invalidateRows(t.rows),c.grid.render()}),this.dataView.onPagingInfoChanged.subscribe(function(e,t){var i=t.pageNum==t.totalPages-1,a=c.grid.getOptions(),o=a.enableAddRow&&(i||0==t.pageSize);a.enableAddRow!=o&&c.grid.setOptions({enableAddRow:o})}),e(this.grid.getHeaderRow()).delegate(":input","change keyup",function(){u[e(this).data("columnId")]=e.trim(e(this).val()),c.dataView.refresh()}),this.grid.onColumnsReordered.subscribe(function(){c.updateHeaderRow(c.localMetaForData)}),this.grid.onColumnsResized.subscribe(function(){c.updateHeaderRow(c.localMetaForData)}),this.grid.onViewportChanged.subscribe(function(){c.grid.getViewport()}),this.grid.onViewportChanged.notify(),this.grid.onBeforeEditCell.subscribe(function(e,t){return l(t.row,t.cell,t.item)?void 0:!1}),this.grid.onActiveCellChanged.subscribe(function(e,t){if(d(t.row)){var i=c.grid.getColumns()[t.cell];if(void 0!==i.options){var a=selectEditor(i.options.property);a!==Tuml.Slick.Editors.SelectOneToOneCellEditor&&c.handleAddNewRow()}else c.handleAddNewRow()}}),this.updateHeaderRow=function(t){for(var i=0;i<this.columns.length;i++)if("selector"!==this.columns[i].id&&"uri"!==this.columns[i].id&&"delete"!==this.columns[i].id){var a=this.grid.getHeaderRowColumn(this.columns[i].id);e(a).empty(),e(m(this.columns[i].id,t)).data("columnId",this.columns[i].id).val(u[this.columns[i].id]).appendTo(a)}},this.grid.onValidationError.subscribe(function(e,t){return e.stopImmediatePropagation(),alert(t.validationResults.msg),!0}),this.setupColumnFormatter(),this.initializeDataModel(t,p),this.updateHeaderRow(this.localMetaForData),this.dataView.syncGridSelection(this.grid,!0)},this.addItems=function(e){for(var t=0;t<e.length;t++)this.dataView.addItem(e[t]),this.dataView.getDeletedItems().remove(e[t]);this.grid.invalidateAllRows(),this.grid.updateRowCount(),this.grid.render()},this.setupRowDrag=function(){var e=new Slick.RowMoveManager({cancelEditOnDrag:!0});e.onBeforeMoveRows.subscribe(function(e,t){for(var i=0;i<t.rows.length;i++)if(t.rows[i]==t.insertBefore||t.rows[i]==t.insertBefore-1)return e.stopPropagation(),!1;return!0}),e.onMoveRows.subscribe(function(e,t){var i,a,r=[],n=t.rows,s=t.insertBefore;i=o.dataView.getItems().slice(0,s),a=o.dataView.getItems().slice(s,o.dataView.getItems().length),n.sort(function(e,t){return e-t});for(var l=0;l<n.length;l++){var d=o.dataView.getItems()[n[l]];r.push(d)}n.reverse();for(var l=0;l<n.length;l++){var m=n[l];s>m?i.splice(m,1):a.splice(m-s,1)}if(n[0]>s-1)for(var l=0;l<r.length;l++){var d=r[l];d._index=i.length+l,o.dataView.updateItem(d.id,d,"_index"),d._movedOrder=Tuml.UmlgListItemMovedOrder++,o.dataView.updateItem(d.id,d,"_movedOrder")}else for(var l=r.length-1;l>=0;l--){var d=r[l];d._index=i.length+l,o.dataView.updateItem(d.id,d,"_index"),d._movedOrder=Tuml.UmlgListItemMovedOrder++,o.dataView.updateItem(d.id,d,"_movedOrder")}o.dataView.setItems(i.concat(r.concat(a)));for(var p=[],l=0;l<n.length;l++)p.push(i.length+l);o.grid.resetActiveCell(),o.grid.setSelectedRows(p),o.grid.render()}),o.grid.registerPlugin(e),o.grid.onDragInit.subscribe(function(e){e.stopImmediatePropagation()})},this.setCellValue=function(e,t){var i=o.dataView.getItemByIdx(e.row);if(void 0===i)throw"item not found for given row in TumlBaseGridManager.setCellValue";i[o.grid.getColumns()[e.cell].name]=t,o.grid.invalidateRows([e.row]),o.grid.updateRowCount(),o.grid.render()}}e.extend(!0,window,{Tuml:{TumlBaseGridManager:r,TumlManyComponentGridManager:i,TumlForManyLookupGridManager:a,TumlQueryGridManager:t,TumlTabGridManager:o,UmlgListItemMovedOrder:0}}),t.prototype=new r,t.prototype.setupOptions=function(){this.options={showHeaderRow:!0,headerRowHeight:30,editable:!1,enableAddRow:!1,enableCellNavigation:!0,asyncEditorLoading:!1,enableAsyncPostRender:!0,forceFitColumns:!1,topPanelHeight:25}},t.prototype.setData=function(e){this.dataView.setItems(e,"row")},i.prototype=new r,i.prototype.initializeDataModel=function(e,t){this.dataView.beginUpdate(),this.dataView.setNewItems(e),this.dataView.setFilterArgs({metaForData:this.localMetaForData}),this.dataView.setFilter(t),this.dataView.endUpdate()},i.prototype.createContextMenu=function(){},a.prototype=new r,a.prototype.isPropertyForGrid=function(e){return e.composite&&e.lower>0?!0:e.inverseQualifiedName===this.propertyNavigatingTo.qualifiedName?!1:e.composite||e.inverseComposite?!1:e.associationClassOne&&!e.memberEndOfAssociationClass?!1:e.oneToOne||e.manyToOne||e.manyPrimitive||e.manyEnumeration?!0:!1},a.prototype.createContextMenu=function(){},o.prototype=new r,o.prototype.createContextMenu=function(){var t=this,i=r.prototype.createContextMenu.call(this),a=e("<li />").appendTo(i);a.data("contextData",{name:"delete"});var o=e("<a />",{title:"delete",tabindex:-1,href:"#"}).appendTo(a);return e('<i class="umlg-icon ui-icon ui-icon-umlpseudostate-terminate" />').appendTo(o),o.append(" delete"),o.on("click",function(a){var o=e(a.target),r=i.parent().data("row");return t.handleContextMenuSelection(o,r),i.parent().hide(),a.preventDefault(),a.stopImmediatePropagation(),!1}),i},r.prototype.refresh=function(t,i){this.metaForDataTo=t.meta.to,this.calculateContainsOne();var a=i;a.children().remove(),e('<div id="serverErrorMsg" />').appendTo(a);var o;o=this instanceof Tuml.TumlManyComponentGridManager?600:e(".ui-layout-center").height()-188,e("<div />",{id:"myGrid"+this.metaForDataTo.name,style:"width:auto;height:"+o+"px;","class":"umlg-slick-grid"}).appendTo(a),e("<div />",{id:"pager"+this.metaForDataTo.name,style:"width:auto;height:20px;"}).appendTo(a),e("#contextMenu"+this.metaForDataTo.name).remove(),this.createGrid(t.data,this.tumlUri)},r.prototype.setupColumnFormatter=function(){var e=this;this.dataView.getItemMetadata=function(t){for(var i=this.getItem(t),a={cssClasses:null,columns:null},o={},r=e.dataView.isRowSaved(t),n=e.dataView.isRowUpdated(t),s=0;s<e.localMetaForData.properties.length;s++){var l=e.localMetaForData.properties[s];if(l.onePrimitive||l.manyPrimitive||l.oneEnumeration||l.manyEnumeration||null!==l.dataTypeEnum)o[l.name]={formatter:selectFormatter(l,r,n)};else if(l.associationClassOne||l.composite&&l.lower>0)if(void 0===i||-1!==this.getNewItems().indexOf(i))if(null!==e.tumlTabViewManager.validationResults&&e.tumlTabViewManager.validationResults.length>0){for(var d=!1,m=0;m<e.tumlTabViewManager.validationResults.length;m++){var p=e.tumlTabViewManager.validationResults[m];if(p.property===l.name){d=!0,o[l.name]={formatter:TumlSlick.Formatters.TumlValidationFailedFormatter};break}}d||(o[l.name]={formatter:TumlSlick.Formatters.TumlRequired})}else o[l.name]=l.associationClassOne?l.lower>0?{formatter:TumlSlick.Formatters.TumlToAssociationClassRequiredFormatter}:{formatter:TumlSlick.Formatters.TumlToAssociationClassFormatter}:{formatter:TumlSlick.Formatters.TumlRequired};else o[l.name]=l.associationClassOne&&!l.memberEndOfAssociationClass?l.manyToOne||l.oneToOne?l.inverseComposite?{formatter:TumlSlick.Formatters.TumlAssociationComponentFormatter}:l.lower>0?{formatter:TumlSlick.Formatters.TumlToAssociationClassRequiredFormatter}:{formatter:TumlSlick.Formatters.TumlToAssociationClassFormatter}:{formatter:TumlSlick.Formatters.TumlAssociationComponentFormatter}:{formatter:TumlSlick.Formatters.TumlComponentFormatter};else o[l.name]={formatter:selectFormatter(l,r,n)}}return a.columns=o,a}},r.prototype.initializeDataModel=function(e,t){this.dataView.beginUpdate(),this.setData(e),this.dataView.setFilterArgs({metaForData:this.localMetaForData}),this.dataView.setFilter(t),this.dataView.endUpdate()},r.prototype.isPropertyForGrid=function(e){return null!==this.contextVertexId&&e.associationClassOne&&e.memberEndOfAssociationClass?!0:null!=this.contextVertexId&&e.associationClassOne&&!e.associationClassProperty?void 0!==this.propertyNavigatingTo&&this.propertyNavigatingTo.associationClassPropertyName===e.inverseAssociationClassPropertyName?!0:!1:!e.composite&&!e.inverseComposite&&e.lower>0&&!e.associationClassOne?!0:e.associationClassProperty?!1:e.composite&&e.lower>0?!0:void 0!==this.propertyNavigatingTo&&e.inverseQualifiedName===this.propertyNavigatingTo.qualifiedName?!1:e.composite||e.inverseComposite||!(e.oneToOne||e.manyToOne||e.manyPrimitive||e.manyEnumeration||null!==e.dataTypeEnum&&(e.upper>1||-1===e.upper))?!1:!0},r.prototype.setupColumns=function(){this.columns=[];for(var e=0;e<this.localMetaForData.properties.length;e++){var t=this.localMetaForData.properties[e];if(this.isPropertyForGrid(t))if("id"==t.name){var i={id:t.name,name:t.name,field:t.name,sortable:!0};void 0!==this.propertyNavigatingTo&&!this.propertyNavigatingTo.associationClassOne&&this.propertyNavigatingTo.ordered&&(i.behavior="selectAndMove",i.cssClass="cell-reorder"),this.columns.push(i)}else this.columns.push({id:t.name,name:t.derived?"/ "+t.name:t.name,field:t.name,sortable:!0,editor:selectEditor(t),validator:selectFieldValidator(t),options:{required:t.lower>0,tumlLookupUri:t.tumlLookupUri,rowEnumerationLookupMap:new RowEnumerationLookupMap(t.qualifiedName,"/"+tumlModelName+"/tumlEnumLookup"),ordered:t.ordered,unique:t.unique,property:t,tumlBaseGridManager:this},width:120})}this.columns.sort(function(e,t){return"id"===e.name?-1:"id"===t.name?1:void 0!==e.editor&&null!==e.editor||void 0===t.editor||null===t.editor?void 0!==t.editor&&null!==t.editor||void 0===e.editor||null===e.editor?void 0!==e.editor&&null!==e.editor||void 0!==t.editor&&null!==t.editor?e.name.localeCompare(t.name):-1:-1:1})},r.prototype.instantiateGrid=function(){this.grid=new Slick.Grid("#myGrid"+this.localMetaForData.name,this.dataView,this.columns,this.options),this.pager=new Slick.Controls.Pager(this.dataView,this.grid,e("#pager"+this.localMetaForData.name)),e("<div id='grid-button"+this.localMetaForData.name+"' class='grid-button'/>").appendTo("#pager"+this.localMetaForData.name+" .slick-pager-settings"),this.grid.manyEditorOpen=!1,this.grid.setSelectionModel(new Slick.RowSelectionModel),new Slick.Controls.ColumnPicker(this.columns,this.grid,this.options)},r.prototype.showContextMenu=function(t,i,a){function o(){l.hide(),n(t)}function r(){window.setTimeout(o,200)}function n(t){for(var i=l.find("a"),a=0;a<i.length;a++){var o=e(i[a]),r=o.attr("href").replace(s.data[t.row].id,"{property}");o.attr("href",r)}}for(var s=this,l=e("#contextMenu"+this.localMetaForData.name),d=l.find("a"),m=0;m<d.length;m++){var p=e(d[m]),u=p.attr("href").replace(new RegExp("{(s*?.*?)*?}","gi"),encodeURIComponent(this.data[t.row].id));p.attr("href",u)}l.data("row",t.row).css({display:"block",left:i,top:a}),l.focus(),e("body").one("click",function(){l.hide(),n(t)}),l.mouseleave(r)},r.prototype.createContextMenu=function(){function t(e,t){return e.name<t.name?-1:e.name>t.name?1:0}var i=this,a=e('<div id="contextMenu'+this.localMetaForData.name+'" class="umlg-context-menu dropdown clearfix" />').appendTo("body"),o=e('<ul id="contextMenuUl" class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1" style="display:block;position:static;margin-bottom:5px;" />').appendTo(a),r=e("<li />").appendTo(o),n=e("<a />",{title:"self",tabindex:-1,href:"#"}).appendTo(r);n.data("contextData",{name:"self",uri:this.localMetaForData.uri}),e('<i class="umlg-icon ui-icon ui-icon-umlactivity-final-node" />').appendTo(n),n.append(" self"),n.on("click",function(t){var o=e(t.target),r=a.data("row");i.handleContextMenuSelection(o,r),a.hide(),t.preventDefault(),t.stopImmediatePropagation()});var s=this.localMetaForData.properties;s.sort(t);for(var l=0;l<s.length;l++){var d=s[l];if(d.inverseComposite||!(void 0!==d.dataTypeEnum&&null!==d.dataTypeEnum||d.onePrimitive||d.manyPrimitive||"id"==d.name||"uri"==d.name)){var m=null;if(d.associationClassOne&&!d.memberEndOfAssociationClass){var p=d.name.split("_");m=1===p.length?p[0]:p[0]+"["+p[1]+"]"}else m=d.name;m+=-1==d.upper?" ["+d.lower+"..*]":" ["+d.lower+".."+d.upper+"]";var u=addUiToUrl(d.tumlUri),r=e("<li />").appendTo(o),n=e("<a />",{title:d.name,tabindex:-1,href:u}).appendTo(r),c="ui-icon";c+=d.composite?" ui-icon-umlcomposition":d.associationClassOne&&!d.memberEndOfAssociationClass?" ui-icon-umlassociationclass":" ui-icon-umlassociation",e('<i class="umlg-icon '+c+'"/>').appendTo(n),n.data("contextData",{name:d.name,property:d}),n.on("click",function(t){var o=e(t.target),r=a.data("row");i.handleContextMenuSelection(o,r),a.hide(),t.preventDefault(),t.stopImmediatePropagation()}),n.append(" "+m),d.derived&&n.append(" {derived}"),void 0!==d.qualified&&d.qualified&&n.append(" [qualified]")}}return o},r.prototype.handleContextMenuSelection=function(e,t){var i=e.data("contextData");if("delete"!==i.name){var a;if("self"!==i.name)if(i.property.composite||i.property.qualified||1!=i.property.upper)a=i.property.tumlUri.replace(new RegExp("{(s*?.*?)*?}","gi"),encodeURIComponent(this.data[t].id));else{if(!i.property.inverseComposite&&null==this.data[t][i.property.name].id)return void alert("Property "+i.property.qualifiedName+" on "+this.localMetaForData.name+" does not exist!\nIt can not be created as it is a non composite property.");a=i.property.tumlUri.replace(new RegExp("{(s*?.*?)*?}","gi"),encodeURIComponent(this.data[t].id))}else a=i.uri.replace(new RegExp("{(s*?.*?)*?}","gi"),encodeURIComponent(this.data[t].id));this.handleContextMenuClickLink(a)}else this.handleDeleteRow(t,this.data)},r.prototype.setupOptions=function(){this.options={autoHeight:!1,showHeaderRow:!0,headerRowHeight:30,editable:!this.propertyNavigatingTo.readOnly,enableAddRow:this.propertyNavigatingTo.composite&&!this.propertyNavigatingTo.associationClassOne?!0:!1,enableCellNavigation:!0,asyncEditorLoading:!1,enableAsyncPostRender:!0,forceFitColumns:!1,topPanelHeight:25,autoEdit:!1}},r.prototype.setData=function(e){this.dataView.setItems(e)},r.prototype.getResult=function(){return this.result}}(jQuery);