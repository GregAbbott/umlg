!function(e){function r(r,t,a,i,u){function s(){n=new Tuml.TumlQueryGridManager(r)}var n,o;this.instanceQueryUri=t,this.classQueryUri=a,this.rootQueryUri=i,void 0!==u&&(this.queryId=u),this.tumlTabViewManager=r,this.executeQuery=function(){var r=this;e.ajax({url:this.oclExecuteUri+"?query="+encodeURIComponent(o.getValue())+"&type="+this.tumlTabViewManager.parentTabContainerManager.executeButton.val()+"&contextClassifierQualifiedName="+this.tumlTabViewManager.parentTabContainerManager.qualifiedName,type:"GET",contentType:"application/json",success:function(e){r.afterExecuteQuery(e)},error:function(t){e("#serverErrorMsg_"+r.queryTabDivName).addClass("server-error-msg").html(t.responseText)}})},this.afterExecuteQuery=function(r){if(Array.isArray(r))if(0!==r[0].data.length)n.refresh(r[0],this.queryTabDivName+"_OclResult",!0);else{var t=e("#"+this.queryTabDivName+"_OclResult");t.children().remove();var a=e("<textarea />",{id:"queryResultId"});a.text("no result").appendTo(t),CodeMirror.fromTextArea(a[0],{mode:"text/x-sh",readOnly:!0})}else{var t=e("#"+this.queryTabDivName+"_OclResult");t.children().remove();var a=e("<textarea />",{id:"queryResultId"});void 0===r.result?a.text(r).appendTo(t):a.text(r.result).appendTo(t),CodeMirror.fromTextArea(a[0],{mode:"text/x-sh",readOnly:!0})}e("#serverErrorMsg_"+this.queryTabDivName).removeClass("server-error-msg"),e("#serverErrorMsg_"+this.queryTabDivName).empty(),e("#tab-container").tabs("resize")},this.saveToInstance=function(){var r=this;this.synchronizeQuery(this.queryId),this.query.qualifiedName="umlglib::org::umlg::query::InstanceQuery";var t={insert:[],update:[],"delete":[]};this.query.post?t.insert.push(this.query):t.update.push(this.query),e.ajax({url:this.instanceQueryUri,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(t),success:function(e){for(var t,a=e[0].data,i=0;i<a.length&&(t=a[i],t.name!=r.query.name);i++);r.query.post?r.afterSaveInstance({queryType:"instanceQuery",query:t,gridData:n.getResult()}):r.afterUpdateInstance({queryType:"instanceQuery",query:t,gridData:n.getResult()})},error:function(r){e("#serverErrorMsg_"+this.queryTabDivName).addClass("server-error-msg").html(r.responseText)}})},this.deleteQuery=function(){var r=this;this.synchronizeQuery(this.queryId);var t;if(""!==this.instanceQueryUri)t=this.instanceQueryUri;else if(""!==this.classQueryUri)t=this.classQueryUri;else{if(""===this.rootQueryUri)throw"Unknown query uri!";t=this.rootQueryUri}var a=""!==this.instanceQueryUri?!0:!1;this.query.qualifiedName=a?"umlglib::org::umlg::query::InstanceQuery":"umlglib::org::umlg::query::ClassQuery";var i={insert:[],update:[],"delete":[]};i.delete.push(this.query),e.ajax({url:t,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(i),success:function(){if(""!==r.instanceQueryUri)r.afterDeleteInstance({queryType:"instanceQuery",query:r.query,gridData:n.getResult()});else if(""!==r.classQueryUri)r.afterDeleteClassQuery({queryType:"classQuery",query:r.query,gridData:n.getResult()});else{if(""===r.rootQueryUri)throw"Unknown query uri!";r.afterDeleteRootQuery({queryType:"rootQuery",query:r.query,gridData:n.getResult()})}},error:function(r){e("#serverErrorMsg_"+queryTabDivName).addClass("server-error-msg").html(r.responseText)}})},this.cancelQuery=function(){var e=this.queryExecuteButtonFormGroupDiv.find("#executeButton");e.text("Execute "+this.query.type.toUpperCase()),e.val(this.query.type.toUpperCase()),o.setValue(this.query.queryString);var r=this.queryQueryNameFormGroupDiv.find("#queryName");r.val(this.query.name)},this.afterSaveInstance=function(e){this.tumlTabViewManager.afterSaveInstance(e)},this.afterUpdateInstance=function(e){this.tumlTabViewManager.afterUpdateInstance(e)},this.afterDeleteInstance=function(e){this.tumlTabViewManager.afterDeleteInstance(e)},this.afterSaveClassQuery=function(e){this.tumlTabViewManager.afterSaveClassQuery(e)},this.afterUpdateClassQuery=function(e){this.tumlTabViewManager.afterUpdateClassQuery(e)},this.afterDeleteClassQuery=function(e){this.tumlTabViewManager.afterDeleteClassQuery(e)},this.afterSaveRootQuery=function(e){this.tumlTabViewManager.afterSaveRootQuery(e)},this.afterUpdateRootQuery=function(e){this.tumlTabViewManager.afterUpdateRootQuery(e)},this.afterDeleteRootQuery=function(e){this.tumlTabViewManager.afterDeleteRootQuery(e)},this.saveToClass=function(){var r=this;this.synchronizeQuery(this.queryId),this.query.qualifiedName="umlglib::org::umlg::meta::ClassQuery";var t={insert:[],update:[],"delete":[]};this.query.post?t.insert.push(this.query):t.update.push(this.query),e.ajax({url:this.classQueryUri,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(t),success:function(e){for(var t,a=e[0].data,i=0;i<a.length&&(t=a[i],t.name!=r.query.name);i++);r.query.post?r.afterSaveClassQuery({queryType:"classQuery",query:t,gridData:n.getResult()}):r.afterUpdateClassQuery({queryType:"classQuery",query:t,gridData:n.getResult()})},error:function(t){e("#serverErrorMsg_"+r.queryTabDivName).addClass("server-error-msg").html(t.responseText)}})},this.saveToRoot=function(){var r=this;this.synchronizeQuery(this.queryId);var t={insert:[],update:[],"delete":[]};this.query.post?t.insert.push(this.query):t.update.push(this.query),e.ajax({url:this.rootQueryUri,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(t),success:function(e){for(var t,a=e[0].data,i=0;i<a.length&&(t=a[i],t.name!=r.query.name);i++);r.query.post?r.afterSaveRootQuery({queryType:"rootQuery",query:t,gridData:n.getResult()}):r.afterUpdateRootQuery({queryType:"rootQuery",query:t,gridData:n.getResult()})},error:function(t){e("#serverErrorMsg_"+r.queryTabDivName).addClass("server-error-msg").html(t.responseText)}})},this.createQuery=function(r,t,a,i){var u=this;this.queryTabDivName=r,this.query=a,this.query.post=i,this.oclExecuteUri=t;var s=e("#"+r),y=e("<div />",{"class":"umlg-query-panel panel panel-default"}).appendTo(s),l=e("<div />",{"class":"panel-body"}).appendTo(y),c=this.tumlTabViewManager.parentTabContainerManager.tabLayoutTabFooterDiv;this.queryExecuteButtonFormGroupDiv,this.queryQueryNameFormGroupDiv,this.querySaveInstanceFormGroupDiv,this.querySaveClassFormGroupDiv,this.queryCancelButtonFormGroupDiv,this.queryDeleteButtonFormGroupDiv;var h=c.find(".form-inline");0!==h.length?(this.queryExecuteButtonFormGroupDiv=h.find("#queryExecuteButtonFormGroupDiv"),this.queryQueryNameFormGroupDiv=h.find("#queryNameFormDiv"),this.querySaveInstanceFormGroupDiv=h.find("#saveInstanceFormGroup"),this.querySaveClassFormGroupDiv=h.find("#saveClassFormGroup"),this.queryCancelButtonFormGroupDiv=h.find("#cancelButtonFormGroup"),this.queryDeleteButtonFormGroupDiv=h.find("#deleteButtonFormGroup")):this.tumlTabViewManager.parentTabContainerManager.addQueryButtons(this.query);var d=e(".ui-layout-center").height()-165,p=e("<div />",{id:"queryLayoutDiv",style:"height: "+d+'px; width" 100%; overflow: hidden;'});p.appendTo(l);var m=e("<div />",{"class":"query-north"}),v=e("<div />",{"class":"query-center"});m.appendTo(p),v.appendTo(p),e("<div />",{id:"serverErrorMsg_"+r}).appendTo(m);var f=e("<div />",{id:r+"_OclOuter","class":"oclouter"});f.appendTo(m);var q=e("<div />",{id:r+"_OclInner","class":"oclinner"}).appendTo(f),g=e("<div />",{"class":"ocltextarea"}).appendTo(q),T=e("<textarea />",{id:r+"_QueryString"});T.text(a.queryString),T.appendTo(g),o=CodeMirror.fromTextArea(T[0],{lineNumbers:!0,extraKeys:{"Ctrl-Space":"autocomplete"},matchBrackets:!0,mode:"text/x-groovy",onKeyEvent:function(e,r){(13===r.which&&r.altKey&&"keydown"===r.type||13===r.which&&r.ctrlKey&&"keydown"===r.type)&&(u.executeQuery(),r.preventDefault())}}),"ocl"===a.type?CodeMirror.commands.autocomplete=function(e){CodeMirror.showHint(e,CodeMirror.hint.ocl,{async:!0,closeOnUnfocus:!0,completeSingle:!0,contextClassifierQualifiedName:u.tumlTabViewManager.parentTabContainerManager.uiManager.leftMenuManager.contextMetaDataFrom.qualifiedName})}:"groovy"===a.type&&(CodeMirror.commands.autocomplete=function(e){CodeMirror.showHint(e,CodeMirror.hint.gremlin,{async:!0,closeOnUnfocus:!0,completeSingle:!1,contextClassifierQualifiedName:u.tumlTabViewManager.parentTabContainerManager.qualifiedName})});var Q=e("<div />",{id:r+"_OclResult","class":"oclresult"});Q.appendTo(v),void 0!==a.data&&null!==a.data&&n.refresh(a.data,r+"_OclResult"),p.layout({center__paneSelector:".query-center",north__paneSelector:".query-north",north__size:125,spacing_open:3,onresize_end:function(){var r=e(".query-north").height()-15;return e(".CodeMirror").height(r),!0}})},this.synchronizeQuery=function(e){this.query.name=this.tumlTabViewManager.parentTabContainerManager.queryQueryNameFormGroupDiv.find("#queryName").val(),this.query.queryString=o.getValue(),this.query.queryEnum=this.tumlTabViewManager.parentTabContainerManager.executeButton.val(),void 0!==e&&(this.query.id=e)},e.extend(this,{TumlTabQueryManagerVersion:"1.0.0",onSelfCellClick:new Tuml.Event}),s()}e.extend(!0,window,{Tuml:{TumlTabQueryManager:r}})}(jQuery);